---
#
# This is the canonical configuration for the `README.md`
# Run `make readme` to rebuild the `README.md`
#

# Name of this project
name: terraform-aws-codebuild-lambda

# License of this project
license: "APACHE2"

# Short description of this project
description: |-
  This AWS Teraform module sets up a CodeBuild/CodePipeline project that deploys a Terraform project from GitHub.

  Just configure the variables with the github settings and an OAuth token giving it permissions to access the code.
  You can also configure the required permissions that the CodeBuild/Pipeline roles require as you wish.

  The `buildspec.yml` file in the source project can be used to match environment variables you set in this project (see Usage).

# Pre-requisites
requirements: |-
   * Terraform 0.12.x (Although this project is written in Terraform 0.12, the pipeline it deploys can be used to deploy using ANY version of Terraform)
   * A github Oauth token stored in AWS SSM Parameter Store
   * A terraform project with an AWS CodeBuild `buildspec.yml` file in the root directory

# How to use this project
usage: |-
  ```hcl
  module "codebuild_tf_lambda_deploy" {
    source = "git::https://github.com/vishbhalla/terraform-aws-codebuild-lambda.git"

    region    = "eu-west-1"
    name      = "somename"
    namespace = "somenamespace"
    stage     = "dev"
    tags      = {
      Owner = "My Company"
    }

    github_owner                  = "github-User-Name"
    github_repo                   = "github_repo_name"
    git_branch                    = "branch_name"
    ssm_param_name_github_token   = "ssm/path_to/github_oath_token"
    codebuild_project_description = "An project that deploys a lambda"

    codebuild_iam_policy_arns = [
      "arn:aws:iam::aws:policy/AWSLambdaFullAccess",
      "arn:aws:iam::aws:policy/AmazonS3FullAccess",
      "arn:aws:iam::aws:policy/CloudWatchLogsFullAccess",
      "arn:aws:iam::aws:policy/AWSCodeBuildDeveloperAccess",
      "arn:aws:iam::aws:policy/IAMFullAccess",
    ]

    codepipeline_iam_policy_arns = [
      "arn:aws:iam::aws:policy/AmazonS3FullAccess",
      "arn:aws:iam::aws:policy/AWSCodeBuildDeveloperAccess"
    ]

    codebuild_env_vars = {
      {
        name  = "TF_VERSION"
        value = "0.11.14"
      },
      {
        name  = "TF_ENV"
        value = "account1_env_vars_file"
      },
      {
        name  = "TF_ACTION"
        value = "apply"
      },
      {
        name  = "TF_IN_AUTOMATION"
        value = "1"
      },
      {
        name  = "TF_LOG"
        value = "DEBUG"
      }
    ]
  }
  ```

  Also see [this example project](https://github.com/vishbhalla/terraform-aws-codebuild-lambda-example)
  The above project is setup to deploy [this example hello world Lambda Terraform project](https://github.com/vishbhalla/terraform-aws-hello-world-lambda)
  Taking particular note of [buildspec.yml](https://github.com/vishbhalla/terraform-aws-hello-world-lambda/blob/master/buildspec.yml) file
  and how it ties in with the environment variables set here in `var.codebuild_env_vars`.

include:
  - "docs/terraform.md"
  - "docs/targets.md"
